{% extends 'base.html' %}

{% block title %}
    Activity Request
{% endblock %}

{% block page_title %}
    <div data-page-title>{{ project_display }}</div>
{% endblock %}

{% block content %}
<div class="sticky-page-title">
    <i class="fa-solid fa-pen-to-square"></i> Activity Request
</div>

{# --- Centralized option templates --- #}
{% set user_options %}
    <option value="">Select Member</option>
    {% for user_detail in user_details %}
        <option value="{{ user_detail.id }}">{{ user_detail.name }}</option>
    {% endfor %}
{% endset %}

{% set team_role_options %}
    <option value="">Select Role</option>
    {% for team_member_detail in team_member_details %}
        <option value="{{ team_member_detail.id }}">{{ team_member_detail.name }}</option>
    {% endfor %}
{% endset %}

{% set key_process_options %}
    <option value="">Select Role</option>
    {% for key_process_detail in key_process_details %}
        <option value="{{ key_process_detail.id }}">{{ key_process_detail.name }}</option>
    {% endfor %}
{% endset %}

<div class="card">
  <form id="activityForm" method="post">

    <div id="activityAccordion">

  <!-- Activity Overview -->
  <div class="card">
    <div class="card-header" id="headingOverview">
      <h6 class="mb-0">
        <button class="accordion-button collapsed" type="button" data-toggle="collapse"
                data-target="#collapseOverview" aria-expanded="false" aria-controls="collapseOverview">
            <i class="fa fa-caret-right caret-icon2 mr-2"></i>
          Activity Overview
        </button>
      </h6>
    </div>

    <div id="collapseOverview" class="collapse" aria-labelledby="headingOverview" data-parent="#activityAccordion">
      <div class="card-body">
        {% set fields = [
            {"id": "subject", "label": "Subject*:", "rows": None, "placeholder": "Enter subject of the activity", "maxlength": 150},
            {"id": "objectives", "label": "Objectives*:", "rows": 3, "placeholder": "State the objectives", "maxlength": 500},
            {"id": "scope", "label": "Scope:", "rows": 3, "placeholder": "Describe the scope of the activity", "maxlength": 500},
            {"id": "stakeholders", "label": "Stakeholders:", "rows": 2, "placeholder": "List involved stakeholders", "maxlength": 500},
            {"id": "deliverables", "label": "Deliverables:", "rows": 2, "placeholder": "Outline expected deliverables", "maxlength": 500},
            {"id": "assumptions", "label": "Assumptions:", "rows": 2, "placeholder": "State any assumptions", "maxlength": 500}
        ] %}
        {% for field in fields %}
          <div class="mb-3">
            <label for="{{ field.id }}" class="form-label">{{ field.label }}</label>
            {% if field.rows %}
              <textarea class="form-control" id="{{ field.id }}" name="{{ field.id }}"
                        rows="{{ field.rows }}" placeholder="{{ field.placeholder }}"
                        {% if field.maxlength %} maxlength="{{ field.maxlength }}" {% endif %}></textarea>
            {% else %}
              <input type="text" class="form-control" id="{{ field.id }}" name="{{ field.id }}"
                     placeholder="{{ field.placeholder }}"
                     {% if field.maxlength %} maxlength="{{ field.maxlength }}" {% endif %}>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Team Composition -->
  <div class="card">
    <div class="card-header" id="headingTeam">
      <h6 class="mb-0">
        <button class="accordion-button collapsed" type="button" data-toggle="collapse"
                data-target="#collapseTeam" aria-expanded="false" aria-controls="collapseTeam">
            <i class="fa fa-caret-right caret-icon2 mr-2"></i>
          Team Composition
        </button>
      </h6>
    </div>
    <div id="collapseTeam" class="collapse" aria-labelledby="headingTeam" data-parent="#activityAccordion">
      <div class="card-body">
            <table class="table table-striped table-bordered table-hover">
              <thead>
                <tr>
                  <th class="text-end">#</th>
                  <th>Member</th>
                  <th>Role</th>
                  <th class="text-end">Action</th>
                </tr>
              </thead>
              <tbody id="teamCompositionInputs">
                  <tr>
                      <td class="text-end">1</td>
                      <td>
                          <select class="form-control" name="team_member_names">
                              {{ user_options | safe }}
                          </select>
                      </td>
                      <td>
                          <select class="form-control" name="team_member_role">
                              {{ team_role_options | safe }}
                          </select>
                      </td>
                      <td></td>
                  </tr>
                  <tr>
                      <td></td>
                      <td colspan="2"></td>
                      <td>
                          <button type="button" class="btn-outline-custom float-end" onclick="addTeamMember()">Add Member</button>
                      </td>
                  </tr>
              </tbody>
            </table>
      </div>
    </div>
  </div>

  <!-- Activity Breakdown -->
  <div class="card">
    <div class="card-header" id="headingBreakdown">
      <h6 class="mb-0">
        <button class="accordion-button collapsed" type="button" data-toggle="collapse"
                data-target="#collapseBreakdown" aria-expanded="false" aria-controls="collapseBreakdown">
            <i class="fa fa-caret-right caret-icon2 mr-2"></i>
          Activity Breakdown
        </button>
      </h6>
    </div>
    <div id="collapseBreakdown" class="collapse" aria-labelledby="headingBreakdown" data-parent="#activityAccordion">
      <div class="card-body">
            <table class="table table-striped table-bordered table-hover">
              <thead>
                <tr>
                  <th class="text-end">#</th>
                  <th>Task</th>
                  <th>Key Process</th>
                  <th>Start Date</th>
                  <th>End Date</th>
                    <th>No. of Days</th>
                  <th class="text-end">Action</th>
                </tr>
              </thead>
              <tbody id="taskInputs">
                <tr>
                  <td class="text-end">1</td>
                  <td><textarea class="form-control" name="task[]" rows="3" placeholder="Enter task name" maxlength="150"></textarea></td>
                  <td>
                      <select class="form-control" name="key_process_names">
                          {{ key_process_options | safe }}
                      </select>
                  </td>
                  <td><input type="text" class="form-control start-date" name="start_date[]" placeholder="Start Date" autocomplete="off"></td>
                  <td><input type="text" class="form-control end-date" name="end_date[]" placeholder="End Date" autocomplete="off"></td>
                  <td class="days-diff text-center">1</td>
                    <td></td>
                </tr>
                <tr class="total-days-row">
                  <td></td>
                  <td colspan="4" class="text-end font-weight-bold">Total No. of Days:</td>
                  <td class="total-days text-center">1</td>
                  <td>
                    <button type="button" class="btn-outline-custom float-end" onclick="addTask()">Add Task</button>
                  </td>
                </tr>
              </tbody>
            </table>
      </div>
    </div>
  </div>

</div>

    <!-- Final Action Buttons -->
    <div class="mt-3 d-flex justify-content-center gap-5">
      <button type="button" class="btn-outline-custom" style="margin: 0 1rem;" onclick="handleAction('save request')">Save Request</button>
      <button type="button" class="btn-outline-custom" style="margin: 0 1rem;" onclick="handleAction('submit request')">Submit Request</button>
    </div>

  </form>
</div>

<script>
  function handleAction(actionType) {
      // Run validation before showing confirmation
      if (!validateForm()) {
          return; // stop if invalid
      }
      showConfirmation(actionType);
  }

function validateForm() {
    let isValid = true;

    // Clear old errors
    $(".text-danger.validation-error").remove();

    // Track which accordions need to open
    let invalidSections = new Set();

    // --- Check Activity Overview: only Subject & Objectives are required ---
    const subjectVal = $("#subject").val().trim();
    if (subjectVal === "") {
        isValid = false;
        $("#subject").after('<div class="text-danger validation-error small">Subject is required.</div>');
        invalidSections.add("#collapseOverview");
    }

    const objectivesVal = $("#objectives").val().trim();
    if (objectivesVal === "") {
        isValid = false;
        $("#objectives").after('<div class="text-danger validation-error small">Objectives are required.</div>');
        invalidSections.add("#collapseOverview");
    }

    // --- Check at least one Team Member (both name and role) ---
    $("#teamCompositionInputs tr").each(function () {
        const name = $(this).find("select[name='team_member_names']").val();
        const role = $(this).find("select[name='team_member_role']").val();
        if (name !== undefined && role !== undefined) {
            if (name.trim() === "" || role.trim() === "") {
                isValid = false;
                $(this).find("td:last").append('<div class="text-danger validation-error small">Select both member and role.</div>');
                invalidSections.add("#collapseTeam");
            }
        }
    });

    // --- Check at least one Task row ---
    let hasTask = false;
    $("#taskInputs tr").each(function () {
        const taskText = $(this).find("textarea[name='task[]']").val();
        const keyProcess = $(this).find("select[name='key_process_names']").val();
        if (taskText !== undefined && keyProcess !== undefined) {
            if (taskText.trim() !== "" && keyProcess.trim() !== "") {
                hasTask = true;
            }
        }
    });
    if (!hasTask) {
        isValid = false;
        $("#taskInputs").after('<div class="text-danger validation-error small">At least one task with a key process is required.</div>');
        invalidSections.add("#collapseBreakdown");
    }

    // Expand all accordion sections with errors
    invalidSections.forEach(function (id) {
        $(id).collapse("show");
    });

    return isValid;
}

    function showConfirmation(actionType) {
        let modalTitle = "";
        let modalMessage = "";

        if (actionType === "save request") {
            modalTitle = "Save Confirmation";
            modalMessage = "Are you sure you want to save this request?";
            $("#confirmAction").off("click").on("click", function () {
                $("#confirmationModal").modal("hide");
                    saveActivityRequest();
            });
        } else if (actionType === "submit request") {
            modalTitle = "Submission Confirmation";
            modalMessage = "Are you sure you want to submit this request?";
            $("#confirmAction").off("click").on("click", function () {
                $("#confirmationModal").modal("hide");
                    //submitFiles();
            });
        }

        $("#confirmationModalLabel").text(modalTitle);
        $("#confirmationMessage").text(modalMessage);

        $("#confirmationModal").modal({
            backdrop: true,
            keyboard: false
        });

        // Wait for Bootstrap to insert backdrop, then adjust z-index
        setTimeout(function () {
            $('.modal-backdrop').last().addClass('confirmation-backdrop');
        }, 10);
    }

    function addTeamMember() {
        const addButtonRow = $("#teamCompositionInputs tr:last");
        const newRowIndex = $("#teamCompositionInputs tr").length;

        const memberOptions = `{{ user_options | safe }}`;
        const roleOptions = `{{ team_role_options | safe }}`;

        const newRow = $(`
            <tr>
                <td class="text-end">${newRowIndex}</td>
                <td><select class="form-control" name="team_member_names">${memberOptions}</select></td>
                <td><select class="form-control" name="team_member_role">${roleOptions}</select></td>
                <td><button class="btn-outline-custom float-end" type="button" onclick="removeField(this)">Remove Member</button></td>
            </tr>
        `);

        addButtonRow.before(newRow);
    }

function addTask() {
    const addButtonRow = $("#taskInputs tr.total-days-row");
    const newRowIndex = $("#taskInputs tr").length;

    const newRow = $(`
        <tr>
            <td class="text-end">${newRowIndex}</td>
            <td><textarea class="form-control" name="task[]" rows="3" placeholder="Enter task name" maxlength="150"></textarea></td>
            <td>
              <select class="form-control" name="key_process_names">
                  {{ key_process_options | safe }}
              </select>
            </td>
            <td><input type="text" class="form-control start-date" placeholder="Start Date" autocomplete="off"></td>
            <td><input type="text" class="form-control end-date" placeholder="End Date" autocomplete="off"></td>
            <td class="days-diff text-center">1</td>
            <td><button class="btn-outline-custom float-end" type="button" onclick="removeField(this)">Remove Task</button></td>
        </tr>
    `);

    addButtonRow.before(newRow);
    initDatePickers(newRow);
}

function removeField(button) {
    $(button).closest("tr").remove();
    calculateTotalDays();
}

    // --- Date validation helpers ---
    function showDateError($row, message) {
        let $err = $row.find('.date-error');
        if (!$err.length) {
            $err = $('<div class="date-error text-danger small mt-1"></div>');
            $row.find('.end-date').closest('td').append($err);
        }
        $err.text(message);
    }

    function clearDateError($row) {
        $row.find('.date-error').remove();
    }

function daysBetween(start, end) {
    const s = new Date(start).setHours(0, 0, 0, 0);
    const e = new Date(end).setHours(0, 0, 0, 0);
    return ((e - s) / (1000 * 60 * 60 * 24)) + 1; // inclusive
}

function calculateDays($row) {
    const startPicker = $row.find('.start-date')[0]?._flatpickr;
    const endPicker = $row.find('.end-date')[0]?._flatpickr;
    if (startPicker && endPicker && startPicker.selectedDates[0] && endPicker.selectedDates[0]) {
        const start = startPicker.selectedDates[0];
        const end = endPicker.selectedDates[0];
        const diff = daysBetween(start, end);
        $row.find('.days-diff').text(diff >= 0 ? diff : 0);
    }
    calculateTotalDays();
}

function calculateTotalDays() {
    let earliest = null;
    let latest = null;

    $("#taskInputs tr").each(function () {
        const startPicker = $(this).find('.start-date')[0]?._flatpickr;
        const endPicker = $(this).find('.end-date')[0]?._flatpickr;

        if (startPicker && endPicker && startPicker.selectedDates[0] && endPicker.selectedDates[0]) {
            const start = startPicker.selectedDates[0];
            const end = endPicker.selectedDates[0];

            if (!earliest || start < earliest) earliest = start;
            if (!latest || end > latest) latest = end;
        }
    });

    if (earliest && latest) {
        const diff = daysBetween(earliest, latest);
        $(".total-days").text(diff >= 0 ? diff : 0);
    } else {
        $(".total-days").text(0);
    }
}

    function initDatePickers(context) {
        context = (context instanceof jQuery) ? context : $(context);
        let rows = context.is('tr') ? context : context.find('tr');

        rows.each(function () {
            const $row = $(this);
            const startElem = $row.find('.start-date')[0];
            const endElem = $row.find('.end-date')[0];
            if (!startElem || !endElem) return;

            // Start date
            if (!startElem._flatpickr) {
                flatpickr(startElem, {
                    enableTime: false,
                    dateFormat: "Y-m-d",
                    allowInput: true,
                    defaultDate: new Date(),
                    onChange: function (selectedDates) {
                        const startDate = selectedDates[0];
                        const endPicker = endElem._flatpickr;
                        if (startDate && endPicker && endPicker.selectedDates[0]) {
                            if (endPicker.selectedDates[0] < startDate) {
                                endPicker.setDate(startDate, false);
                                showDateError($row, 'End Date cannot be earlier than Start Date. Adjusted automatically.');
                            } else {
                                clearDateError($row);
                            }
                        }
                        calculateDays($row);
                    }
                });
            }

            // End date
            if (!endElem._flatpickr) {
                flatpickr(endElem, {
                    enableTime: false,
                    dateFormat: "Y-m-d",
                    allowInput: true,
                    defaultDate: new Date(),
                    onChange: function (selectedDates) {
                        const endDate = selectedDates[0];
                        const startPicker = startElem._flatpickr;
                        if (endDate && startPicker && startPicker.selectedDates[0]) {
                            if (endDate < startPicker.selectedDates[0]) {
                                this.setDate(startPicker.selectedDates[0], false);
                                showDateError($row, 'End Date cannot be earlier than Start Date. Adjusted automatically.');
                            } else {
                                clearDateError($row);
                            }
                        }
                        calculateDays($row);
                    }
                });
            }
        });
    }

    function saveActivityRequest() {
        // Overview fields
        const overview = {
            subject: $("#subject").val(),
            objectives: $("#objectives").val(),
            scope: $("#scope").val(),
            stakeholders: $("#stakeholders").val(),
            deliverables: $("#deliverables").val(),
            assumptions: $("#assumptions").val()
        };

        // Team members
        const team = [];
        $("#teamCompositionInputs tr").each(function () {
            const member_id = $(this).find("select[name='team_member_names']").val();
            const role_id = $(this).find("select[name='team_member_role']").val();
            if (member_id && role_id) {
                team.push({ member_id: member_id, role_id: role_id });
            }
        });

        // Tasks
        const tasks = [];
        $("#taskInputs tr").each(function () {
            const task = $(this).find("textarea[name='task[]']").val();
            const keyProcess = $(this).find("select[name='key_process_names']").val();
            const startDate = $(this).find("input.start-date").val();
            const endDate = $(this).find("input.end-date").val();
            const days = $(this).find(".days-diff").text();

            if (task && keyProcess && startDate && endDate) {
                tasks.push({
                    task: task,
                    key_process: keyProcess,
                    start_date: startDate,
                    end_date: endDate,
                    days: parseInt(days)
                });
            }
        });

        const payload = {
            overview: overview,
            team: team,
            tasks: tasks
        };

        $.ajax({
            url: "/save_activity_request",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(payload),
            success: function (response) {
                showFlashMessage(response.message, "success");
                $("#flashMessageModal").off("hidden.bs.modal").on("hidden.bs.modal", function () {
                    location.reload();
                });
            },
            error: function (xhr) {
                let errorMessage = xhr.responseJSON?.error || "An unexpected error occurred.";
                let messageType = xhr.responseJSON?.type || "danger";
                showFlashMessage(errorMessage, messageType);
            }
        });
    }

    $(document).ready(function () {
        initDatePickers($('#taskInputs'));

        // Rotate caret icons on accordion expand/collapse
        $(document).on("show.bs.collapse", "#activityAccordion .collapse", function () {
            $(this).prev(".card-header").find(".caret-icon2").addClass("rotated");
        });

        $(document).on("hide.bs.collapse", "#activityAccordion .collapse", function () {
            $(this).prev(".card-header").find(".caret-icon2").removeClass("rotated");
        });
    });
</script>

<style>
    #confirmationModal { z-index: 1060; }
    #roleModal { z-index: 1050; }
    .modal-backdrop.confirmation-backdrop { z-index: 1055; }
</style>
{% endblock %}
