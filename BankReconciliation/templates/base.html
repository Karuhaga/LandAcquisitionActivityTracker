<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>
         Bank Reconciliation Tracker -
         {% block title %}

         {% endblock %}
      </title>
      <link rel="icon" href="/static/images/logo_only.png" type="image/x-icon" />
      <link rel="stylesheet" href="/static/bs/css/bootstrap.min.css">
      <link rel="stylesheet" href="/static/fontawesome/css/all.css">
      <link rel="stylesheet" href="/static/css/styles.css">
      <script src="/static/bs/js/jquery-3.7.1.js"></script>
      <script src="/static/bs/js/popper.min.js"></script>
      <script src="/static/bs/js/bootstrap.js"></script>
      <script>
         //dynamically loading content in the content div
         $(document).ready(function() {
            //highlight active vertical menu item
             function setActiveNavLink() {
                 $(".nav-link").removeClass("active"); // Remove active class from all links
                 $(".nav-link").each(function() {
                     if (this.href === window.location.href) {
                         $(this).addClass("active"); // Add active class to the current link
                     }
                 });
             }

             const dashboardUrl = "{{ url_for('dashboard_page') }}";

             let lastPage = sessionStorage.getItem("lastPage") || dashboardUrl;
             loadContent(lastPage);

             function loadContent(url) {
                 $.get(url, function(data) {
                   let newContent = $(data).find(".content").html();
                    let newPageTitle = $(data).find("[data-page-title]").html();
                    let newTitle = $(data).filter("title").text().trim();

                    if (newContent) {
                        $(".content").html(newContent);
                    }

                    if (newPageTitle) {
                        $("#dynamic-page-title").html(newPageTitle);
                    }

                    if (newTitle) {
                        document.title = newTitle;
                    } else {
                        document.title = "Bank Reconciliation Tracker"; // Default title
                    }

                     // Save current page in sessionStorage

                     sessionStorage.setItem("lastPage", url);

                     // Update active menu highlighting
                     setActiveNavLink();

                 }).fail(function() {
                     alert("Error loading page.");
                 });
             }

             // Intercept navigation clicks
             $("a.nav-link").on("click", function(e) {
                 const url = $(this).attr("href");

                 // Allow full refresh for login and logout pages
                 if (url === "{{ url_for('login_page') }}" || url === "{{ url_for('logout_page') }}") {
                     sessionStorage.removeItem("lastPage"); //clearing the lastPage to enable display of dashboard on successful login
                     return; // Skip custom handling for these links
                 }

                 e.preventDefault();

                 // Load content into the content div
                 loadContent(url);

                 // Update browser history.
                 history.pushState(null, null, url);
             });

             // Handle back/forward button navigation
             window.onpopstate = function() {
                 $.get(location.href, function(data) {
                     loadContent(location.href);
                 });
             };

             $(".menu-collapse-heading").on("click", function(e) {
                 const url = $(this).attr("href");

                 // Check if the clicked link is the Dashboard
                 if (url === "{{ url_for('dashboard_page') }}") {
                     e.preventDefault(); // Prevent default link behavior

                     // Collapse any expanded accordion panels
                     $("#accordion .panel-collapse.show").collapse("hide");

                     // Load the dashboard content dynamically
                     $.get(url, function(data) {
                         $(".content").html($(data).find(".content").html());
                     }).fail(function() {
                         alert("Failed to load dashboard content.");
                     });

                     // Update the browser history state
                     history.pushState(null, null, url);
                 }
             });
         });

         // Dynamically change direction of caret icon
         $(document).on("show.bs.collapse", ".panel-collapse", function() {
             $(this).closest(".panel").find(".caret-icon").addClass("rotated");
         });

         $(document).on("hidden.bs.collapse", ".panel-collapse", function() {
             $(this).closest(".panel").find(".caret-icon").removeClass("rotated");
         });
      </script>

   </head>
   <body>
      <header>
         <nav class="navbar navbar-expand-md navbar-light bg-light" style="background-color: #fff;">
            <a class="navbar-brand" href="">
            <img src="/static/images/logo_5.png" style="height: 80px;">
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
            </button>
            {% set pages_with_no_navbar_menu = ['/', '/login', '/home']%}
            {% if request.path not in pages_with_no_navbar_menu %}
            <div class="collapse navbar-collapse" id="navbarNav" style="">
               {% if current_user.is_authenticated %}
               <ul class="navbar-nav ml-auto" style="">
                  <li class="nav-item">
                     <a class="nav-link" href="{{ url_for('logout_page') }}">Logout</a>
                  </li>
               </ul>
               {% else %}
               {% endif %}
            </div>
            {% endif %}
         </nav>
      </header>
      <main style="background-color: #eeeff1;">
         {% set pages_with_no_page_title = ['/', '/login', '/home']%}
         {% if request.path not in pages_with_no_page_title %}
         <div id="dynamic-page-title" style="width:100%; border-bottom: 2px solid #dfdfe0; background-color: #f8f9fa; padding: 5px 5px 5px 10px; font-size: 15px;">
             {% block page_title %}
             {% endblock %}
         </div>
         {% endif %}

         {% set pages_with_no_sidebar = ['/', '/login', '/home']%}
         {% if request.path not in pages_with_no_sidebar %}
         <!-- sidebar start -->
         <input type="checkbox" id="sidebarExpandCollapse">
         <div class="sidebar scrollable full-height-minus-header">
            <div class="row">
               <label for="sidebarExpandCollapse">
               <i class="fa-solid fa-chevron-right" id="sidebar_btn_right"></i>
               </label>
               <label for="sidebarExpandCollapse">
               <i class="fa-solid fa-chevron-left" id="sidebar_btn_left"></i>
               </label>
            </div>
            <div class="panel-group" id="accordion">
               <div class="panel panel-default">
                  <div class="panel-heading">
                     <a class="nav-link menu-collapse-heading d-flex align-items-center {% if request.path == url_for('dashboard_page') %} active {% endif %}" href="{{ url_for('dashboard_page') }}"> <i class="fa fa-chart-pie" aria-hidden="true"></i><span>Dashboard</span><i class="fa fa-caret-down caret-icon" style="visibility: hidden;"></i></a>
                  </div>
               </div>
               <div class="panel panel-default">
                  <div class="panel-heading">
                     <a data-toggle="collapse" data-parent="#accordion" href="#collapse2" class="menu-collapse-heading d-flex align-items-center"><i class="fa-sharp fa-solid fa-list-check"></i><span>Actions</span><i class="fa fa-caret-down caret-icon" style=""></i></a>
                  </div>
                  <div id="collapse2" class="panel-collapse collapse" data-parent="#accordion">
                     <a class="nav-link {% if request.path == url_for('submit_reconciliation_page') %} active {% endif %}" href="{{ url_for('submit_reconciliation_page') }}"> <i class="fa-solid fa-paper-plane"></i><span>Submit Reconciliation</span></a>
                     <a class="nav-link {% if request.path == url_for('previous_submission_page') %} active {% endif %}" href="{{ url_for('previous_submission_page') }}"> <i class="fa-solid fa-folder"></i><span>Previous Submissions</span></a>
                  </div>
               </div>
               <div class="panel panel-default">
                  <div class="panel-heading">
                     <a data-toggle="collapse" data-parent="#accordion" href="#collapse3" class="menu-collapse-heading d-flex align-items-center"><i class="fa-sharp fa-solid fa-toolbox"></i><span>Administration</span><i class="fa fa-caret-down caret-icon"></i></a>
                  </div>
                  <div id="collapse3" class="panel-collapse collapse" data-parent="#accordion">
                     <div class="panel-body">
                        <a class="nav-link {% if request.path == url_for('dashboard_page') %} active {% endif %}" href="{{ url_for('dashboard_page') }}"> <i class="fa-sharp fa-solid fa-list-check"></i><span>Submit</span></a>
                        <a class="nav-link {% if request.path == url_for('dashboard_page') %} active {% endif %}" href="{{ url_for('dashboard_page') }}"> <i class="fa-sharp fa-solid fa-list-check"></i><span>Approve</span></a>
                     </div>
                  </div>
               </div>
               <div class="panel panel-default">
                  <div class="panel-heading">
                     <a data-toggle="collapse" data-parent="#accordion" href="#collapse4" class="menu-collapse-heading d-flex align-items-center"><i class="fa fa-file" aria-hidden="true"></i><span><span></span>Reports</span><i class="fa fa-caret-down caret-icon"></i></a>
                  </div>
                  <div id="collapse4" class="panel-collapse collapse" data-parent="#accordion">
                     <div class="panel-body">
                        <a class="nav-link {% if request.path == url_for('dashboard_page') %} active {% endif %}" href="{{ url_for('dashboard_page') }}"> <i class="fa-sharp fa-solid fa-list-check"></i><span>Submit</span></a>
                        <a class="nav-link {% if request.path == url_for('dashboard_page') %} active {% endif %} " href="{{ url_for('dashboard_page') }}"> <i class="fa-sharp fa-solid fa-list-check"></i><span>Approve</span></a>
                     </div>
                  </div>
               </div>
               <div class="panel panel-default">
                  <div class="panel-heading">
                     <a class="nav-link" href="{{ url_for('logout_page') }}"> <i class="fa-solid fa-right-from-bracket"></i><span>Logout</span><i class="fa fa-caret-down caret-icon" style="visibility: hidden;"></i></a>
                  </div>
               </div>
            </div>
         </div>
         <!-- sidebar end -->
         {% endif %}
         <div class="content scrollable full-height-minus-header">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">
               <button type="button" class="m1-2 mb-1 close" data-dismiss="alert" aria-label="Close">
               <span aria-hidden="true">&times;</span>
               </button>
               {{ message }}
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}
            {% block content %}
            {% endblock %}
         </div>
      </main>
   </body>
</html>