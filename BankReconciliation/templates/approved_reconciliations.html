{% extends 'base.html' %}

{% block title %}
    Approved Reconciliations
{% endblock %}

{% block page_title %}
    <div data-page-title>Approved Reconciliations</div>
{% endblock %}


{% block content %}

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Approved Reconciliations</span>

            <div class="d-flex align-items-center flex-wrap gap-2 py-2">
                <div class="input-group input-group-sm" style="max-width: 200px;">
                    <span class="input-group-text text-muted"
                          style="font-weight: 400; font-size: 0.8rem; color: #484a52; height: calc(1.5em + 0.5rem + 2px);">
                        From
                    </span>
                    <input type="text" id="minDate" class="form-control"
                           placeholder="Start Date/Time"
                           style="height: calc(1.4em + 0.5rem + 2px);">
                </div>

                <div class="input-group input-group-sm" style="max-width: 200px;">
                    <span class="input-group-text text-muted"
                          style="font-weight: 400; font-size: 0.8rem; color: #484a52; height: calc(1.5em + 0.5rem + 2px);">
                        To
                    </span>
                    <input type="text" id="maxDate" class="form-control"
                           placeholder="End Date/Time"
                           style="height: calc(1.4em + 0.5rem + 2px);">
                </div>
            </div>
        </div>

        <div class="card-body">
            <table id="uploadedFilesTable" class="table table-striped table-bordered table-hover paginated">
                <thead>
                    <tr>
                        <th data-orderable="false" data-ordering="false">#</th> <!-- Row number column -->
                        <th>Bank Account</th>
                        <th>Year</th>
                        <th>Month</th>
                        <th>Status</th>
                        <th>Created On</th>
                        <th data-orderable="false" data-ordering="false">Download File</th>
                        <th data-orderable="false" data-ordering="false">View Request</th>
                    </tr>
                </thead>
                <tbody id="uploadedFilesBody">
                    {% for reconciliation in reconciliations %}
                    <tr>
                        <td>{{ loop.index }}</td> <!-- Display row number -->
                        <td>{{ reconciliation.bank_account }}</td>
                        <td>{{ reconciliation.year }}</td>
                        <td>{{ reconciliation.month }}</td>
                        <td>{{ reconciliation.status }}</td>
                        <td>{{ reconciliation.date_time }}</td>
                        <td>
                            <button class="btn-outline-custom download-btn" style="float: right;" type="button" data-filename="{{ reconciliation.file_name }}">Download</button>
                        </td>
                        <td>
                            <button class="btn-outline-custom view-request-btn" style="float: right;" type="button" data-filename="{{ reconciliation.file_name }}">View</button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td colspan="8" style="text-align: center;">No submitted reconciliations found.</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% include 'includes/flash_message_modal.html' %}
    {% include 'includes/reconciliation_file_details_modal.html' %}

<script>

    function showFlashMessage(message, type) {
        let title = "Notification"; // Default title

        if (type === "danger") {
            title = "Error";
        } else if (type === "success") {
            title = "Success";
        } else if (type === "warning") {
            title = "Warning";
        }

        $("#flashMessageTitle").text(title);
        $("#flashMessageBody").html(message);
        $("#flashMessageModal").modal("show");
    }

    $(document).ready(function() {
        // Custom filter for DataTables
        $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
            let min = $('#minDate').val();
            let max = $('#maxDate').val();
            let dateStr = data[5]; // Adjust index if "Last Modified" is not at index 6

            if (!dateStr) return true; // Include rows without a date

            let rowDate = flatpickr.parseDate(dateStr, "Y-m-d H:i");
            if (!rowDate) return true; // Include if unable to parse

            min = min ? flatpickr.parseDate(min, "Y-m-d H:i") : null;
            max = max ? flatpickr.parseDate(max, "Y-m-d H:i") : null;

            if (
                (!min && !max) ||
                (!min && rowDate <= max) ||
                (min <= rowDate && !max) ||
                (min <= rowDate && rowDate <= max)
            ) {
                return true;
            }
            return false;
        });
        // Calculate default date range (last 30 days)
        let now = new Date();
        let thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(now.getDate() - 30);

        // Format dates for Flatpickr input (Y-m-d H:i)
        function formatDate(date) {
            return date.getFullYear() + "-" +
                String(date.getMonth() + 1).padStart(2, '0') + "-" +
                String(date.getDate()).padStart(2, '0') + " " +
                String(date.getHours()).padStart(2, '0') + ":" +
                String(date.getMinutes()).padStart(2, '0');
        }

        $("#minDate").val(formatDate(thirtyDaysAgo));
        $("#maxDate").val(formatDate(now));

        // Initialize Flatpickr
        flatpickr("#minDate", {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            time_24hr: true,
            allowInput: true
        });
        flatpickr("#maxDate", {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            time_24hr: true,
            allowInput: true
        });

        const table = $('#uploadedFilesTable').DataTable({
            paging: true,
            searching: true,
            ordering: true,
            lengthMenu: [5, 10, 25, 50, 100],
            pageLength: 10,
            dom:
                '<"row"<"col-md-6"l><"col-md-6"f>>' +
                '<"row"<"col-md-12"B>>' +
                '<"row"<"col-md-12"t>>' +
                '<"row"<"col-md-6"i><"col-md-6"p>>',
            buttons: [
                { extend: 'copy', text: 'Copy', className: 'btn btn-secondary' },
                { extend: 'csv', text: 'Export to CSV', className: 'btn btn-secondary' },
                { extend: 'excel', text: 'Export to Excel', className: 'btn btn-secondary' },
                { extend: 'pdfHtml5', text: 'Export to PDF', className: 'btn btn-secondary',
                  orientation: 'landscape',
                  customize: function (doc) {
                      doc.content.splice(0, 0, {
                          image: logoBase64,
                          width: 100,
                          alignment: 'left',
                          margin: [0, 0, 0, 10]
                      });
                  }
                },
                { extend: 'print', text: 'Print', className: 'btn btn-secondary',
                  orientation: 'landscape',
                  customize: function (win) {
                      $(win.document.body).prepend(
                          '<div style="text-align:left; margin-bottom:10px;">' +
                          '<img src="' + logoBase64 + '" style="width:200px;" />' +
                          '</div>'
                      );
                  }
                }
            ],
            language: {
                search: "Search:",
                lengthMenu: "Show _MENU_ entries per page",
                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                paginate: {
                    first: "First",
                    last: "Last",
                    next: "Next",
                    previous: "Previous"
                }
            },
            columnDefs: [
                { orderable: false, targets: 0 } // Disable ordering on # column
            ]
        });

        // Add dynamic row numbering
        table.on('order.dt search.dt draw.dt', function () {
            table.column(0, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
                cell.innerHTML = i + 1;
            });
        }).draw();

        // Filter table on initial load for last 30 days
        table.draw();

        // Redraw when user changes date filters
        $('#minDate, #maxDate').on('change', function () {
            table.draw();
        });

        // Calling the reconciliation_file_details_modal.html
        $(document).off("click", ".view-request-btn").on("click", ".view-request-btn", function() {
            let row = $(this).closest("tr");

            let bankAccount = row.find("td:nth-child(2)").text().trim();
            let year = row.find("td:nth-child(3)").text().trim();
            let month = row.find("td:nth-child(4)").text().trim();
            let lastModified = row.find("td:nth-child(7)").text().trim();
            let approveAs = row.find("td:nth-child(6)").text().trim();
            let fileName = $(this).data("filename");

            // Populate the modal fields
            $("#viewBankAccount").text(bankAccount);
            $("#viewYear").text(year);
            $("#viewMonth").text(month);
            $("#viewLastModified").text(lastModified);
            $("#viewApproveAs").text(approveAs);
            $("#viewFileName").text(fileName);

            // Fetch workflow details
            loadReconciliationWorkflow(bankAccount, year, month, fileName);

            // Show the modal after data is populated
            $("#viewRequestModal").modal("show");
        });

        // Handle "Close" button click
        $("#closeViewRequest").click(function() {
            $("#viewRequestCard").slideUp();
        });

        // Handle "Download File" button click
        $(document).on("click", ".download-btn", function() {
            let fileName = $(this).data("filename");
            if (fileName) {
                window.location.href = `/download/${encodeURIComponent(fileName)}`;
            } else {
                alert("File not found.");
            }
        });

        // Handle "Select All" checkbox
        $('#selectAll').on('click', function() {
            $('.rowCheckbox').prop('checked', $(this).prop('checked'));
        });

        // Uncheck "Select All" if any row checkbox is unchecked
        $(document).on('change', '.rowCheckbox', function() {
            if (!$(this).prop('checked')) {
                $('#selectAll').prop('checked', false);
            } else if ($('.rowCheckbox:checked').length === $('.rowCheckbox').length) {
                $('#selectAll').prop('checked', true);
            }
        });
    });

    function approveReconciliations() {
    let files = [];

    $("#uploadedFilesBody tr").each(function () {
        let checkbox = $(this).find(".rowCheckbox");

        // Process only checked rows
        if (checkbox.prop("checked")) {
            let bankAccount = $(this).find("td:nth-child(2)").text().trim();
            let year = $(this).find("td:nth-child(3)").text().trim();
            let month = $(this).find("td:nth-child(4)").text().trim();
            let fileName = $(this).find("td:nth-child(7) .download-btn").data("filename");

            console.log("Row Data:", { bankAccount, year, month, fileName });

            if (fileName && bankAccount && year && month) {
                files.push({
                    bank_account_id: bankAccount,
                    year: year,
                    month: month,
                    file_name: fileName,
                });
            }
        }
    });

    if (files.length === 0) {
        errorMessage = "No files to approve.";
        messageType = "warning";
        showFlashMessage(errorMessage, messageType);
        return;
    }

    console.log("Sending Data:", JSON.stringify({ files })); // Debugging line

    $.ajax({
        url: "/approve-reconciliations-update",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ files: files }),
        success: function (response) {
            alert(response.message);
            location.reload(); // Refresh the page to reflect changes
        },
        error: function (xhr) {
            alert(xhr.responseJSON ? xhr.responseJSON.error : "An error occurred.");
        }
    });
}

</script>

{% endblock %}