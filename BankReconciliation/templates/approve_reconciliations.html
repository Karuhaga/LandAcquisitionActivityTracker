{% extends 'base.html' %}

{% block title %}
    Approve Reconciliations
{% endblock %}

{% block page_title %}
    <div data-page-title>Approve Reconciliations</div>
{% endblock %}


{% block content %}

    <div class="card">
       <div class="card-header">
           Approve Reconciliations
       </div>

        <div class="card-body">
            <table id="uploadedFilesTable" class="table table-striped table-bordered table-hover paginated">
                <thead>
                    <tr>
                        <th data-orderable="false" data-ordering="false"><input type="checkbox" id="selectAll"></th><!-- Select all checkbox -->
                        <th data-orderable="false" data-ordering="false">#</th> <!-- Row number column -->
                        <th>Bank Account</th>
                        <th>Year</th>
                        <th>Month</th>
                        <th>Last Modified</th>
                        <th>Approve As</th>
                        <th data-orderable="false" data-ordering="false">Download File</th>
                        <th data-orderable="false" data-ordering="false">View Request</th>
                    </tr>
                </thead>
                <tbody id="uploadedFilesBody">
                    {% for reconciliation in reconciliations %}
                    <tr>
                        <td><input type="checkbox" class="rowCheckbox"></td> <!-- Row checkbox -->
                        <td>{{ loop.index }}</td> <!-- Display row number -->
                        <td>{{ reconciliation.bank_account }}</td>
                        <td>{{ reconciliation.year }}</td>
                        <td>{{ reconciliation.month }}</td>
                        <td>{{ reconciliation.date_time }}</td>
                        <td>{{ reconciliation.approve_as }}</td>
                        <td>
                            <button class="btn-outline-custom download-btn" style="float: right;" type="button" data-filename="{{ reconciliation.file_name }}">Download</button>
                        </td>
                        <td>
                            <button class="btn-outline-custom view-request-btn" style="float: right;" type="button" data-filename="{{ reconciliation.file_name }}">View</button>
                       </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td></td>
                        <td></td>
                        <td style="text-align: center;">No submitted reconciliations found.</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
                        <table class="" style="width: 100%; margin-top: 1rem;">
                <thead></thead>
                <tbody>
                    <tr>
                        <td style="text-align: center;">
                            <div class="button-container">
                                <button class="btn-outline-custom" type="button" onclick="approveReconciliations()">Approve Reconciliation(s)</button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="loadingIndicator" style="display:none; text-align:center;">
        <img src="{{ url_for('static', filename='spinner.gif') }}" alt="Loading...">
    </div>

<script>
    function showFlashMessage(message, type) {
        let title = "Notification"; // Default title

        if (type === "danger") {
            title = "Error";
        } else if (type === "success") {
            title = "Success";
        } else if (type === "warning") {
            title = "Warning";
        }

        $("#flashMessageTitle").text(title);
        $("#flashMessageBody").html(message);
        $("#flashMessageModal").modal("show");
    }

    function approveReconciliations() {
        files = [];

        $("#uploadedFilesBody tr").each(function() {
            let checkbox = $(this).find(".rowCheckbox");

            // Process only checked rows
            if (checkbox.prop("checked")) {
                let bankAccount = $(this).find("td:nth-child(3)").text().trim();
                let year = $(this).find("td:nth-child(4)").text().trim();
                let month = $(this).find("td:nth-child(5)").text().trim();
                let fileName = $(this).find("td:nth-child(8) .download-btn").data("filename");

                if (fileName && bankAccount && year && month) {
                    files.push({
                        bank_account_id: bankAccount,
                        year: year,
                        month: month,
                        file_name: fileName,
                    });
                }
            }
        });

        if (files.length === 0) {
            errorMessage = "No files to approve.";
            messageType = "warning";
            showFlashMessage(errorMessage, messageType);
            return;
        }

        // Open the modal
        $("#approvalActionModal").modal("show");
    }

    // Handle submission from the modal
    $(document).on("click", "#confirmApprovalAction", function() {
        let action = $("#approvalAction").val();
        let comment = $("#approvalComment").val().trim();

        if (!action) {
            showFlashMessage("Please select an action.", "warning");
            return;
        }

        $.ajax({
            url: "/approve-reconciliations-update",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                files: files,
                action: action,
                comment: comment
            }),
            beforeSend: function() {
                $("#loadingIndicator").show(); // Show loading spinner
            },
            success: function(response) {
                $("#confirmApprovalAction").prop("disabled", false);
                $("#loadingIndicator").hide(); // Hide loading spinner
                $("#approvalActionModal").modal("hide");
                showFlashMessage(response.message, "success");

                $("#flashMessageModal").on("hidden.bs.modal", function() {
                    // Save expanded panels
                    let expandedPanels = [];
                    $(".panel-collapse.in, .panel-collapse.show").each(function() {
                        expandedPanels.push(this.id);
                    });
                    localStorage.setItem("expandedPanels", JSON.stringify(expandedPanels));
                    files = [];
                    // $(".content").load(location.href + " .content > *"); // Reload only the content div
                    location.reload();
                });
            },
            error: function(xhr) {
                $("#loadingIndicator").hide(); // Hide loading spinner on error
                let errorMessage = xhr.responseJSON.error || "An unexpected error occurred.";
                let messageType = xhr.responseJSON.type || "danger";
                showFlashMessage(errorMessage, messageType)
            }
        });
    });

    $(document).ready(function() {
        $('.rowCheckbox, #selectAll').prop('checked', false);

        // Restore sidebar expanded state
        const savedPanels = JSON.parse(localStorage.getItem("expandedPanels") || "[]");
        savedPanels.forEach(function(id) {
            const panel = $("#" + id);
            panel.addClass("in show"); // For Bootstrap 3 or 4
            panel.prev(".panel-heading").find(".menu-collapse-heading").attr("aria-expanded", "true");
        });

        // Optionally clear the stored value if you want one-time restoration
        localStorage.removeItem("expandedPanels");

        $('#uploadedFilesTable').DataTable({
            paging: true, // Enable pagination
            searching: true, // Enable search box
            ordering: true, // Enable column sorting
            columnDefs: [{
                    orderable: false,
                    targets: 0
                } // Disable sorting for the first column (checkbox)
            ],
            lengthMenu: [5, 10, 25, 50, 100], // Rows per page options
            pageLength: 10, // Default number of rows per page
            dom: '<"row"<"col-md-6"l><"col-md-6"f>>' + // Keep "Show entries" & "Search"
                '<"row"<"col-md-12"B>>' + // Buttons in a separate row
                '<"row"<"col-md-12"t>>' + // Table
                '<"row"<"col-md-6"i><"col-md-6"p>>', // Info & Pagination
            buttons: [{
                    extend: 'copy',
                    text: 'Copy',
                    className: 'btn btn-secondary'
                },
                {
                    extend: 'csv',
                    text: 'Export to CSV',
                    className: 'btn btn-secondary'
                },
                {
                    extend: 'excel',
                    text: 'Export to Excel',
                    className: 'btn btn-secondary'
                },
                {
                    extend: 'pdf',
                    text: 'Export to PDF',
                    className: 'btn btn-secondary'
                },
                {
                    extend: 'print',
                    text: 'Print',
                    className: 'btn btn-secondary'
                }
            ],
            language: {
                search: "Search:",
                lengthMenu: "Show _MENU_ entries per page",
                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                paginate: {
                    first: "First",
                    last: "Last",
                    next: "Next",
                    previous: "Previous"
                }
            }
        });

        // Handle "Download File" button click
        $(document).on("click", ".download-btn", function() {
            let fileName = $(this).data("filename");
            if (fileName) {
                window.location.href = `/download/${fileName}`;
            } else {
                alert("File not found.");
            }
        });

        // Handle "Select All" checkbox
        $('#selectAll').on('click', function() {
            $('.rowCheckbox').prop('checked', $(this).prop('checked'));
        });

        // Uncheck "Select All" if any row checkbox is unchecked
        $(document).on('change', '.rowCheckbox', function() {
            if (!$(this).prop('checked')) {
                $('#selectAll').prop('checked', false);
            } else if ($('.rowCheckbox:checked').length === $('.rowCheckbox').length) {
                $('#selectAll').prop('checked', true);
            }
        });
    });

    // Calling the reconciliation_file_details_modal.html
    $(document).on("click", ".view-request-btn", function() {
        let row = $(this).closest("tr");

        let bankAccount = row.find("td:nth-child(3)").text().trim();
        let year = row.find("td:nth-child(4)").text().trim();
        let month = row.find("td:nth-child(5)").text().trim();
        let lastModified = row.find("td:nth-child(6)").text().trim();
        let approveAs = row.find("td:nth-child(7)").text().trim();
        let fileName = $(this).data("filename");

        // Populate the modal fields
        $("#viewBankAccount").text(bankAccount);
        $("#viewYear").text(year);
        $("#viewMonth").text(month);
        $("#viewLastModified").text(lastModified);
        $("#viewApproveAs").text(approveAs);
        $("#viewFileName").text(fileName);

        // Fetch workflow details
        loadReconciliationWorkflow(bankAccount, year, month, fileName);

        // Show the modal after data is populated
        $("#viewRequestModal").modal("show");
    });

    // Handle "Close" button click
    $("#closeViewRequest").click(function() {
        $("#viewRequestCard").slideUp();
    });
</script>

{% endblock %}