{% extends 'base.html' %}

{% block title %}
    Reconciliations Pending Submission
{% endblock %}

{% block page_title %}
    <div data-page-title>Reconciliations Pending Submission</div>
{% endblock %}


{% block content %}

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Reconciliations Pending Submission</span>

            <div class="d-flex align-items-center flex-wrap gap-2 py-2">
                <div class="input-group input-group-sm" style="max-width: 200px;">
                    <span class="input-group-text text-muted"
                          style="font-weight: 400; font-size: 0.8rem; color: #484a52; height: calc(1.5em + 0.5rem + 2px);">
                        Days Overdue From
                    </span>
                    <input type="number" id="minOverdue" class="form-control"
                           placeholder="Overdue days above"
                           style="height: calc(1.5em + 0.5rem + 2px); text-align: right;">
                </div>

                <div class="input-group input-group-sm" style="max-width: 200px;">
                    <span class="input-group-text text-muted"
                          style="font-weight: 400; font-size: 0.8rem; color: #484a52; height: calc(1.5em + 0.5rem + 2px);">
                        Days Overdue To
                    </span>
                    <input type="number" id="maxOverdue" class="form-control"
                           placeholder="Overdue days below"
                           style="height: calc(1.5em + 0.5rem + 2px); text-align: right;">
                </div>
            </div>
        </div>

        <div class="card-body">
            <table id="uploadedFilesTable" class="table table-striped table-bordered table-hover paginated">
                <thead>
                    <tr>
                        <th data-orderable="false" data-ordering="false">#</th> <!-- Row number column -->
                        <th>Bank Account</th>
                        <th>Year</th>
                        <th>Month</th>
                        <th>Days Overdue</th>
                        <th>Responsible Person(s)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reconciliation in reconciliations %}
                    <tr>
                        <td>{{ loop.index }}</td> <!-- Display row number -->
                        <td>{{ reconciliation.bank_account }}</td>
                        <td>{{ reconciliation.year }}</td>
                        <td>{{ reconciliation.month }}</td>
                        <td>{{ reconciliation.days_overdue }}</td>
                        <td>{{ reconciliation.responsible_users }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td style="text-align: center;">No submitted reconciliations found.</td>
                        <td></td>
                        <td></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

<script>
    // Custom numeric filter for Days Overdue
    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
        let min = parseInt($('#minOverdue').val(), 10);
        let max = parseInt($('#maxOverdue').val(), 10);
        let overdue = parseInt(data[4], 10); // "Days Overdue" column index is 4

        if (isNaN(overdue)) return false; // exclude rows without valid integer

        if ((isNaN(min) || overdue >= min) && (isNaN(max) || overdue <= max)) {
            return true;
        }
        return false;
    });

    $(document).ready(function () {
        const table = $('#uploadedFilesTable').DataTable({
            paging: true,
            searching: true,
            ordering: true,
            lengthMenu: [5, 10, 25, 50, 100],
            pageLength: 10,
            dom:
                '<"row"<"col-md-6"l><"col-md-6"f>>' +
                '<"row"<"col-md-12"B>>' +
                '<"row"<"col-md-12"t>>' +
                '<"row"<"col-md-6"i><"col-md-6"p>>',
            buttons: [
                {
                    extend: 'copy',
                    text: 'Copy',
                    className: 'btn btn-secondary',
                    exportOptions: {
                        stripHtml: false,
                        columns: ':visible',
                        format: {
                            body: function (data, row, column, node) {
                                return $(node).text().trim();
                            }
                        }
                    }
                },
                {
                    extend: 'csv',
                    text: 'Export to CSV',
                    className: 'btn btn-secondary',
                    exportOptions: {
                        stripHtml: false,
                        columns: ':visible',
                        format: {
                            body: function (data, row, column, node) {
                                return $(node).text().trim();
                            }
                        }
                    }
                },
                {
                    extend: 'excel',
                    text: 'Export to Excel',
                    className: 'btn btn-secondary',
                    exportOptions: {
                        stripHtml: false,
                        columns: ':visible',
                        format: {
                            body: function (data, row, column, node) {
                                return $(node).text().trim();
                            }
                        }
                    }
                },
                {
                    extend: 'pdfHtml5',
                    text: 'Export to PDF',
                    className: 'btn btn-secondary',
                    orientation: 'landscape',
                    customize: function (doc) {
                        doc.content.splice(0, 0, {
                            image: logoBase64,
                            width: 100,
                            alignment: 'left',
                            margin: [0, 0, 0, 10]
                        });
                    },
                    exportOptions: {
                        stripHtml: false,
                        columns: ':visible',
                        format: {
                            body: function (data, row, column, node) {
                                return $(node).text().trim();
                            }
                        }
                    }
                },
                {
                    extend: 'print',
                    text: 'Print',
                    className: 'btn btn-secondary',
                    orientation: 'landscape',
                    customize: function (win) {
                        $(win.document.body).prepend(
                            '<div style="text-align:left; margin-bottom:10px;">' +
                            '<img src="' + logoBase64 + '" style="width:200px;" />' +
                            '</div>'
                        );
                    },
                    exportOptions: {
                        stripHtml: false,
                        columns: ':visible',
                        format: {
                            body: function (data, row, column, node) {
                                return $(node).text().trim();
                            }
                        }
                    }
                }
            ],
            language: {
                search: "Search:",
                lengthMenu: "Show _MENU_ entries per page",
                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                paginate: {
                    first: "First",
                    last: "Last",
                    next: "Next",
                    previous: "Previous"
                }
            },
            columnDefs: [
                { orderable: false, targets: 0 } // Disable ordering on # column
            ]
        });

        // Add dynamic row numbering in the UI
        table.on('order.dt search.dt draw.dt', function () {
            table.column(0, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
                cell.innerHTML = i + 1;
            });
        }).draw();

        // Automatically set min/max inputs to table's min/max Days Overdue
        let overdueValues = table.column(4).data().map(x => parseInt(x, 10)).toArray().filter(Number.isFinite);
        if (overdueValues.length) {
            let minValue = Math.min(...overdueValues);
            let maxValue = Math.max(...overdueValues);
            $('#minOverdue').val(minValue);
            $('#maxOverdue').val(maxValue);
        }

        // Redraw when user changes min/max filters
        $('#minOverdue, #maxOverdue').on('keyup change', function () {
            table.draw();
        });
    });
</script>

{% endblock %}