{% extends 'base.html' %}

{% block title %}
    Users
{% endblock %}

{% block page_title %}
    <div data-page-title>Users</div>
{% endblock %}


{% block content %}

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Users</span>
            <button style="font-size: 18px;" class="btn-outline-custom" type="button" onclick="addUser()">Add User</button>
        </div>

        <div class="card-body">
            <table id="uploadedFilesTable" class="table table-striped table-bordered table-hover paginated">
                <thead>
                    <tr>
                        <th data-orderable="false" data-ordering="false">#</th> <!-- Row number column -->
                        <th style="width: 8%; white-space: nowrap; text-align: left;">Username</th>
                        <th style="width: 8%; white-space: nowrap; text-align: left;">Name</th>
                        <th style="width: 15%; white-space: nowrap; text-align: left;">Email</th>
                        <td style="max-width: 150px; white-space: normal; overflow-wrap: break-word; font-weight: bold;">Organisational Unit Tier</td>
                        <th style="width: 8%; white-space: nowrap; text-align: left;">Organisational Unit</th>
                        <th style="width: 8%; white-space: nowrap; text-align: left;">Status</th>
                        <th style="max-width: 100px; white-space: normal; overflow-wrap: break-word; font-weight: bold;" data-orderable="false" data-ordering="false">Edit</th>
                        <th style="max-width: 100px; white-space: normal; overflow-wrap: break-word; font-weight: bold;" data-orderable="false" data-ordering="false">Change Password</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user_detail in user_details %}
                    <tr>
                        <td>{{ loop.index }}</td> <!-- Display row number -->
                        <td style="max-width: 100px; white-space: normal; overflow-wrap: break-word; font-weight: normal;">{{ user_detail.username }}</td>
                        <td style="max-width: 100px; white-space: normal; overflow-wrap: break-word; font-weight: normal;">{{ user_detail.name }}</td>
                        <td style="max-width: 150px; word-break: break-all; white-space: normal;">{{ user_detail.email_address }}</td>
                        <th style="width: 8%; white-space: nowrap; text-align: left; font-weight: normal;">{{ user_detail.organisation_unit_tier_name }}</th>
                        <td style="max-width: 150px; white-space: normal; overflow-wrap: break-word;">{{ user_detail.organisation_unit_name }}</td>
                        <td style="max-width: 100px; white-space: normal; overflow-wrap: break-word; font-weight: normal;">{{ user_detail.status }}</td>
                        <td style="max-width: 100px; white-space: normal; overflow-wrap: break-word; font-weight: bold;">
                            <button class="btn-outline-custom edit-user-btn" style="float: right;" type="button" data-filename="{{ user_detail.username }}">Update</button>
                        </td>
                        <td style="max-width: 100px; white-space: normal; overflow-wrap: break-word; font-weight: bold;">
                            <button class="btn-outline-custom change-password-btn" style="float: right;" type="button" data-filename="{{ user_detail.username }}">Password</button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td style="text-align: center; max-width: 150px; word-break: break-all; white-space: normal;">No user(s) found.</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

<script>
    function showFlashMessage(message, type) {
        let title = "Notification"; // Default title

        if (type === "danger") {
            title = "Error";
        } else if (type === "success") {
            title = "Success";
        } else if (type === "warning") {
            title = "Warning";
        }

        $("#flashMessageTitle").text(title);
        $("#flashMessageBody").html(message);
        $("#flashMessageModal").modal("show");
    }

    function addUser() {
        // Open the modal
        $("#addUserModal").modal("show");
    }

    function editUser() {
        // Open the modal
        $("#editUserModal").modal("show");
    }

    function updateUserPassword() {
        // Open the modal
        $("#changeUserPasswordModal").modal("show");
    }

    // Calling the user_edit_modal.html
    $(document).off("click", ".edit-user-btn").on("click", ".edit-user-btn", function () {
        const userName = $(this).closest("tr").find("td:nth-child(2)").text().trim();

        $.ajax({
            url: "/get-user-account-details",
            type: "GET",
            data: { user_name: userName },
            success: function (data) {
                // Populate modal fields
                $("#username2").val(data.username);
                $("#fname2").val(data.fname);
                $("#mname2").val(data.mname || '');
                $("#sname2").val(data.sname);
                $("#email2").val(data.email || '');

                // Set the Organisation Unit Tier and trigger change
                $("#organisationUnitTier2").val(function () {
                    return $("#organisationUnitTier2 option").filter(function () {
                        return $(this).text().trim() === data.organisation_unit_tier_name;
                    }).val();
                }).trigger("change");  // Trigger the change event

                // Wait for the organisation units to load before setting the selected unit
                setTimeout(function () {
                    $("#organisationUnit2").val(function () {
                        return $("#organisationUnit2 option").filter(function () {
                            return $(this).text().trim() === data.organisation_unit_name;
                        }).val();
                    });
                }, 300);  // Adjust timing if necessary

                // Set the active status
                if (data.is_active === true || data.is_active === 1) {
                    $("#activeYes").prop("checked", true);
                } else {
                    $("#activeNo").prop("checked", true);
                }

                // Show the modal
                $("#editUserModal").modal("show");
            },
            error: function () {
                showFlashMessage("Failed to load user details. Please try again.", "danger");
            }
        });
    });

    // Calling the user_password_change_modal.html
    $(document).off("click", ".change-password-btn").on("click", ".change-password-btn", function () {

        const userName = $(this).closest("tr").find("td:nth-child(2)").text().trim();

        $.ajax({
            url: "/get-user-account-details",
            type: "GET",
            data: { user_name: userName },
            success: function (data) {
                // Populate modal fields
                $("#username3").val(data.username);

                // Show the modal
                $("#changeUserPasswordModal").modal("show");
            },
            error: function () {
                showFlashMessage("Failed to load user details. Please try again.", "danger");
            }
        });
    });

    function validatePasswordComplexity(password) {
        // At least 8 characters, one uppercase, one lowercase, one number, one special char
        const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_\-+=\[\]{};':"\\|,.<>\/?]).{8,}$/;
        return regex.test(password);
    }

    // Handle submission from the user_password_change_modal.html
    $(document).off("click", ".confirmPasswordUpdateAction").on("click", "#confirmPasswordUpdateAction", function () {

        const form = document.getElementById("userPasswordChangeForm");

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const password = $("#password3").val();
        const confirmPassword = $("#confirm_password3").val();

        if (password !== confirmPassword) {
            showFlashMessage("Passwords do not match.", "danger");
            return;
        }

        if (!validatePasswordComplexity(password)) {
            showFlashMessage("Password must be at least 8 characters long and include uppercase, lowercase, digit, and special character.", "danger");
            return;
        }

        const formData = {
            username: $("#username3").val(),
            password: password,
            confirmPassword: confirmPassword
        };

        // Update password
        $.ajax({
            url: "/admin-user-password-update",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(formData),
            success: function (response) {
                $("#changeUserPasswordModal").modal("hide");
                showFlashMessage(response.message, "success");
                $("#flashMessageModal").on("hidden.bs.modal", function () {
                    $(".content").load(location.href + " .content > *", function() {
                        initializeRoleDataTable(); // <-- reinitialize after content is loaded
                    });
                });
            },
            error: function (xhr) {
                let errorMessage = xhr.responseJSON?.error || "An unexpected error occurred.";
                let messageType = xhr.responseJSON?.type || "danger";
                showFlashMessage(errorMessage, messageType);
            }
        });
    });

    // Handle submission from the add_user_modal.html
    $(document).off("click", "#confirmSubmissionAction").on("click", "#confirmSubmissionAction", function () {
        const form = document.getElementById("approvalForm");

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const password = $("#password").val();
        const confirmPassword = $("#confirm_password").val();

        if (password !== confirmPassword) {
            showFlashMessage("Passwords do not match.", "danger");
            return;
        }

        if (!validatePasswordComplexity(password)) {
            showFlashMessage("Password must be at least 8 characters long and include uppercase, lowercase, digit, and special character.", "danger");
            return;
        }

        const formData = {
            username: $("#username").val().trim(),
            email: $("#email").val(),
            fname: $("#fname").val(),
            mname: $("#mname").val(),
            sname: $("#sname").val(),
            password: password,
            confirm_password: confirmPassword,
            organisationUnitTier: $("#organisationUnitTier").val(),
            organisationUnit: $("#organisationUnit").val(),
        };

        // Step 1: Check if username exists
        $.ajax({
            url: `/check-username/${encodeURIComponent(formData.username)}`,
            type: "GET",
            success: function (response) {
                if (response.exists) {
                    showFlashMessage(`Username '${formData.username}' already exists.`, "warning");
                    return;
                }

                // Step 2: Submit new user
                $.ajax({
                    url: "/admin-register-new-user",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(formData),
                    success: function (response) {
                        $("#addUserModal").modal("hide");
                        showFlashMessage(response.message, "success");
                    $("#flashMessageModal").on("hidden.bs.modal", function () {
                        $(".content").load(location.href + " .content > *", function() {
                            initializeRoleDataTable();
                        });
                    });
                    },
                    error: function (xhr) {
                        let errorMessage = xhr.responseJSON?.error || "An unexpected error occurred.";
                        let messageType = xhr.responseJSON?.type || "danger";
                        showFlashMessage(errorMessage, messageType);
                    }
                });
            },
            error: function () {
                showFlashMessage("Failed to validate username. Please try again.", "danger");
            }
        });
    });

    // Handle submission from the user_edit_modal.html
    $(document).off("click", "#confirmUpdateAction").on("click", "#confirmUpdateAction", function () {
        const form = document.getElementById("userEditForm");

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const formData = {
            username: $("#username2").val(),
            email: $("#email2").val(),
            fname: $("#fname2").val(),
            mname: $("#mname2").val(),
            sname: $("#sname2").val(),
            organisationUnitTier: $("#organisationUnitTier2").val(),
            organisationUnit: $("#organisationUnit2").val(),
            is_active: $('input[name="is_active"]:checked').val(),
        };

        $.ajax({
            url: "/admin-update-user",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(formData),
            success: function (response) {
                $("#editUserModal").modal("hide");
                showFlashMessage(response.message, "success");
                $("#flashMessageModal").on("hidden.bs.modal", function () {
                    $(".content").load(location.href + " .content > *", function() {
                        initializeRoleDataTable(); // <-- reinitialize after content is loaded
                    });
                });
            },
            error: function (xhr) {
                let errorMessage = xhr.responseJSON?.error || "An unexpected error occurred.";
                let messageType = xhr.responseJSON?.type || "danger";
                showFlashMessage(errorMessage, messageType);
            }
        });
    });

     function initializeRoleDataTable() {
        $('#uploadedFilesTable').DataTable({
            paging: true,
            searching: true,
            ordering: true,
            lengthMenu: [5, 10, 25, 50, 100],
            pageLength: 10,
            destroy: true, // <-- Important to allow reinitialization
            dom: '<"row"<"col-md-6"l><"col-md-6"f>>' +
                 '<"row"<"col-md-12"B>>' +
                 '<"row"<"col-md-12"t>>' +
                 '<"row"<"col-md-6"i><"col-md-6"p>>',
            buttons: [
                { extend: 'copy', text: 'Copy', className: 'btn btn-secondary' },
                { extend: 'csv', text: 'Export to CSV', className: 'btn btn-secondary' },
                { extend: 'excel', text: 'Export to Excel', className: 'btn btn-secondary' },
                { extend: 'pdf', text: 'Export to PDF', className: 'btn btn-secondary' },
                { extend: 'print', text: 'Print', className: 'btn btn-secondary' }
            ],
            language: {
                search: "Search:",
                lengthMenu: "Show _MENU_ entries per page",
                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                paginate: {
                    first: "First",
                    last: "Last",
                    next: "Next",
                    previous: "Previous"
                }
            }
        });
    }

    $(document).ready(function() {
        initializeRoleDataTable()

        // Handle "Close" button click
        $("#closeViewRequest").click(function() {
            $("#viewRequestCard").slideUp();
        });

    });

    $(document).on('hidden.bs.modal', function () {
        if ($('.modal.show').length > 0) {
            // Keep 'modal-open' if any modal is still open
            $('body').addClass('modal-open');
        }
    });

</script>

{% endblock %}